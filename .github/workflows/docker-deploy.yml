name: Deploy to AWS

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 下載程式碼
      - uses: actions/checkout@v4

      # 2. 設定 Java 環境
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. Maven 打包
      - name: Build with Maven
        run: mvn -f InsuranceSystem/pom.xml clean package -DskipTests

      # 4. 登入 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. 推送 App Image
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./InsuranceSystem
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest

      # 6. [新增] 將 init-db.sql 傳送到 AWS 伺服器
      # 這是為了確保伺服器上有最新的 SQL 腳本可以執行
      - name: Copy SQL file to AWS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "InsuranceSystem/init-db.sql" # 你的 SQL 檔案路徑
          target: "/home/${{ secrets.SERVER_USER }}/deploy" # 目標路徑 (會自動建立)
          strip_components: 1 # 去掉第一層目錄，直接把檔案放在 deploy 資料夾

      # 7. 連線到 AWS 並執行「毀滅性重建」
      - name: Deploy to EC2 (App + Reset DB)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # 這裡假設你的 DB 密碼存在 GitHub Secrets 的 DB_PASSWORD
          # 如果你的 init-db.sql 裡有寫死密碼，這裡的 SA_PASSWORD 要跟裡面一致
          script: |
            # --- 0. 環境準備 ---
            # 建立 Docker 網路 (如果不存在)
            docker network create insurance-net || true

            # --- 1. 清理舊環境 (App & DB) ---
            echo "停止並刪除舊容器..."
            docker stop insurance-app || true
            docker rm insurance-app || true
            docker stop mssql-db || true
            docker rm mssql-db || true

            # [關鍵步驟] 刪除資料庫 Volume，確保資料歸零
            echo "刪除舊資料庫 Volume..."
            docker volume rm mssql_data || true

            # --- 2. 啟動全新資料庫 ---
            echo "啟動 MSSQL 資料庫..."
            docker run -d \
              --name mssql-db \
              --network insurance-net \
              -e "ACCEPT_EULA=Y" \
              -e "SA_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              -p 1433:1433 \
              -v mssql_data:/var/opt/mssql \
              -v /home/${{ secrets.SERVER_USER }}/deploy/init-db.sql:/tmp/init-db.sql \
              mcr.microsoft.com/mssql/server:2022-latest

            # --- 3. 執行 SQL 初始化腳本 ---
            echo "等待資料庫啟動 (30秒)..."
            sleep 30 # MSSQL 啟動需要時間，必須等待

            echo "執行 init-db.sql..."
            docker exec mssql-db /opt/mssql-tools/bin/sqlcmd \
              -S localhost -U sa -P "${{ secrets.DB_PASSWORD }}" \
              -i /tmp/init-db.sql

            # --- 4. 啟動應用程式 ---
            echo "更新並啟動應用程式..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest
            
            docker run -d \
              --name insurance-app \
              --network insurance-net \
              -p 8080:8080 \
              -e SPRING_DATASOURCE_URL=jdbc:sqlserver://mssql-db:1433;databaseName=insurancesystem;encrypt=false \
              -e SPRING_DATASOURCE_USERNAME=sa \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }} \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest