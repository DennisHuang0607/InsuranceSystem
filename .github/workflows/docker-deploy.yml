name: Deploy to AWS

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -f InsuranceSystem/pom.xml clean package -DskipTests

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./InsuranceSystem
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest

      - name: Copy SQL file to AWS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "InsuranceSystem/init-db.sql"
          target: "/home/${{ secrets.SERVER_USER }}/deploy"
          strip_components: 1

      - name: Deploy to EC2 (Debug Mode)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # --- 環境準備 ---
            docker network create insurance-net || true

            # --- 清理 ---
            echo "Removing old containers..."
            docker stop insurance-app || true
            docker rm insurance-app || true
            docker stop mssql-db || true
            docker rm mssql-db || true
            docker volume rm mssql_data || true

            # --- 啟動 DB ---
            echo "Starting MSSQL..."
            docker run -d \
              --name mssql-db \
              --network insurance-net \
              -e "ACCEPT_EULA=Y" \
              -e "SA_PASSWORD=${{ secrets.DB_PASSWORD }}" \
              -p 1433:1433 \
              -v mssql_data:/var/opt/mssql \
              -v /home/${{ secrets.SERVER_USER }}/deploy/init-db.sql:/tmp/init-db.sql \
              mcr.microsoft.com/mssql/server:2022-latest

            # --- [除錯重點] 檢查 DB 是否活著 ---
            echo "Wait 45s for DB startup..."
            sleep 45 
            
            echo "Check DB container status:"
            docker ps -a | grep mssql-db

            # 如果容器死掉了，印出日誌讓我們知道為什麼 (例如密碼太簡單)
            if [ "$(docker inspect -f '{{.State.Running}}' mssql-db)" = "false" ]; then
                echo "❌ CRITICAL ERROR: Database container crashed!"
                echo "--- DB LOGS START ---"
                docker logs mssql-db
                echo "--- DB LOGS END ---"
                exit 1
            fi

            # --- 執行 SQL ---
            echo "Running init-db.sql..."
            # 這裡加上詳細錯誤輸出 (-b OnError)
            docker exec mssql-db /opt/mssql-tools/bin/sqlcmd \
              -S localhost -U sa -P "${{ secrets.DB_PASSWORD }}" \
              -i /tmp/init-db.sql -b

            # --- 啟動 App ---
            echo "Starting App..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest
            
            docker run -d \
              --name insurance-app \
              --network insurance-net \
              -p 8080:8080 \
              -e SPRING_DATASOURCE_URL="jdbc:sqlserver://mssql-db:1433;databaseName=insurancesystem;encrypt=false" \
              -e SPRING_DATASOURCE_USERNAME=sa \
              -e SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              --restart unless-stopped \
              ${{ secrets.DOCKER_USERNAME }}/insurance-system:latest